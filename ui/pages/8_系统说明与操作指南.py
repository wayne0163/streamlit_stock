import os
import sys
import streamlit as st

sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from utils.ui_helpers import init_state, show_status_panel

init_state()
show_status_panel()

@st.cache_data
def get_guide_content():
    return """
# streamlit-股票分析系统 · 操作指南（重点：策略）

## 一、系统模块速览
- 数据管理：更新全市场基础信息、拉取/刷新自选股与指数的行情（日线）。
- 自选列表管理：维护股票/指数自选池，并可勾选加入回测池。
- 选股策略：选择策略，在“最后一个交易日”做一次性判定并输出列表（不下单）。
- 回测引擎：Backtrader 驱动的逐日回测，支持多标的、多仓位平均分配、业绩指标与图表。
- 资产管理：模拟盘管理（持仓、交易记录、净值快照）。
- 风险分析：组合层面的回撤、波动、风险暴露等（可扩展）。
- 指数对比：沪深300等基准对比与相对强弱分析。

使用建议顺序：先“数据管理”→“自选列表管理”→“选股策略/回测引擎”。

---

## 二、策略运行框架（通用）
- 数据口径：日线前复权（data_fetcher 使用 Tushare `pro_bar(..., adj='qfq')`）。
- 最小样本：默认要求至少 240 根日线样本（慢速指标与稳健缓冲）。不足则不参与。
- 选股（Screening）：只看“最后一日”是否满足策略的入场条件（或在有效窗口内），给出信号与诊断字段。
- 回测（Backtest）：
  - 买入：当日满足“入场条件”则当日收盘买入（`exectype=Close`）。
  - 卖出：满足“卖出条件”的当天收盘生成卖单，次日开盘成交（全仓卖出）。
  - 资金分配：`RemainingCashSizer` 将剩余现金均分到空余仓位槽（由 `max_positions` 控制）。
  - 交易成本：手续费率在 `config/settings.py`（`BACKTEST_FEE_RATE`）；滑点为 0.01%。
  - 分析器：夏普、回撤、收益、交易统计、日度收益序列（用于净值图与回撤图）。

---

## 三、策略详解：WeeklyMACDFilterStrategy（周线MACD + 日线过滤）
策略思路：用周线 MACD 做趋势确认，再用日线做成交量与价格过滤；买在当日收盘、破位次日开盘卖出。

1) 周线趋势确认（在每个周五收盘时更新）
- 指标：周线 EMA12/EMA26/DEA9；DIF=EMA12-EMA26，DEA=EMA(DIF,9)。
- 金叉：上周 DIF ≤ DEA 且 本周 DIF > DEA。
- 零轴附近：本周 DIF ∈ [-0.05, +0.15]。
- 低分位：本周 DIF ≤ 过去 20 周 DIF 的 20% 分位数（不含本周）。
- 若上述三条同时成立，记录“完整周线信号”的周（记为‘信号周’），并记下当时的日线 bar 索引。

2) 信号有效窗口（可调，默认 N=3 个交易日）
- 从“信号周”的周五起，向后数 N 个交易日内均视为“有效窗口”。
- 仅在有效窗口内的某个交易日，才继续检查日线过滤以触发买入。

3) 日线过滤（在有效窗口内逐日判定）
- 成交量：当日成交量 > MA3 且 > MA18（简单均量，日线）。
- 价格：当日收盘价 > SMA20。
- 满足则当日收盘买入（回测为 `exectype=Close`；选股只报告信号）。

4) 卖出条件
- 收盘价 < SMA20，则在次日开盘价卖出全部持仓。

5) 可调参数（选股与回测 UI 可设）
- `signal_valid_days`：周线信号 N 日内有效，默认 3，范围 1–20。

6) 数据要求
- 周线需要至少 30 个周点；日线需要至少 240 根。

7) 典型用途
- 适合偏趋势跟随的中期交易，利用“周线趋势确认 + 日线过滤”降低假信号概率。

---

## 四、策略详解：SMA20_120_VolStop30Strategy（20/120 金叉 + 量能过滤 + 30 日止损）
策略思路：以 20/120 均线金叉为主信号，成交量做过滤，允许“信号后的 N 日内”继续有效；跌破止损均线（默认 30 日）次日卖出。

1) 入场信号与有效窗口（默认 N=3）
- 金叉定义：`SMA(fast)` 上穿 `SMA(slow)`（默认 fast=20、slow=120）。
- 有效窗口：金叉发生后的 N 个交易日内仍可触发买入。
- 当日维持条件：在“判定日”需同时满足：
  - 收盘价 ≥ `SMA(fast)`（不低于快线）
  - 成交量 > `MA3` 且 > `MA18`
- 满足上述条件则当日收盘买入（回测 `exectype=Close`；选股只报告信号）。

2) 卖出条件
- 收盘价 < `SMA(stop)`（默认 30），次日开盘全部卖出。

3) 可调参数（选股与回测 UI 可设）
- `sma_fast`：快线窗口（默认 20）
- `sma_slow`：慢线窗口（默认 120）
- `sma_stop`：止损均线（默认 30）
- `vol_ma_short` / `vol_ma_long`：量能短/长均线窗口（默认 3 / 18）
- `signal_valid_days`：金叉信号 N 日内有效（默认 3，范围 1–20）

4) 数据要求
- 至少 240 根日线样本；建议覆盖慢线窗口及一定缓冲期。

5) 典型用途
- 适合关注中线趋势转强的参与点，并用量能与不跌破快线的要求提高信号质量。

---

## 五、选股与回测的操作步骤
1) 选股
- 打开“选股策略”，选择 `WeeklyMACDFilterStrategy` 或 `SMA20_120_VolStop30Strategy`。
- 根据需要在参数面板中设置有效天数/均线与量能窗口。
- 点击“开始选股”，系统将对自选池逐一判定“最后一日”是否触发入场条件，结果支持导出 CSV。

2) 回测
- 打开“回测引擎”，选择策略，设置回测时间区间、初始资金、最大持仓与策略参数。
- 点击“开始回测”，查看：
  - 策略总收益、年化、最大回撤、夏普、交易统计。
  - 净值曲线及与沪深300对比，回撤曲线。
  - 交易记录/订单执行明细 CSV 下载。

---

## 六、常见问题（FAQ）
- 为什么某些标的不参与？
  - 样本不足（少于 240 根日线或周线不足 30 周）会被跳过。
- 选股与回测结果为何不同？
  - 选股仅看“最后一日”的一次性判定；回测为逐日模拟，受交易成本、持仓上限、同时入场排序影响。
- 周线判定是否严格周五？
  - 近似以“W-FRI”聚合；若遇节假日，周末点可能对应前一交易日。

---

## 七、附录：内部实现要点
- 管理器 `strategies/manager.py`：动态加载策略类；若模块提供 `screen_stock(df, params)` 则优先用其做选股判定。
- 回测引擎 `backtest/engine.py`：透传 `strategy_params` 至 `cerebro.addstrategy`；资金分配器 `RemainingCashSizer` 平均分配剩余现金到空余仓位。
- 两个策略模块：
  - `strategies/macd_weekly_filter.py`：实现周线MACD状态、N日有效窗口、日线过滤与卖出逻辑，含 `screen_stock`。
  - `strategies/ma_cross_simple.py`：实现 20/120 金叉 + 量能过滤 + N 日有效 + 30 日止损，含 `screen_stock`。
"""

st.header("系统说明与操作指南")
st.markdown(get_guide_content())
